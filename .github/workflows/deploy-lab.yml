name: Deploy to Lab (Simplified)

on:
  workflow_dispatch:
    inputs:
      target_dc:
        description: "Target DC IP or hostname"
        required: true
        type: string
        default: "20.50.126.169"
      skip_validation:
        description: "Skip pre-promotion checks"
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      target_dc:
        description: "Target DC IP or hostname"
        required: true
        type: string
      skip_validation:
        description: "Skip pre-promotion checks"
        required: false
        type: boolean
        default: false
    secrets:
      DOMAIN_ADMIN_USERNAME:
        required: true
      DOMAIN_ADMIN_PASSWORD:
        required: true
      SAFE_MODE_PASSWORD:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PowerShell modules
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Installing PSWSMan for cross-platform WinRM..." -ForegroundColor Cyan
          Install-Module -Name PSWSMan -Scope CurrentUser -Force -AllowClobber -ErrorAction Stop
          
          Write-Host "ğŸ“¦ Verifying PSWSMan..." -ForegroundColor Cyan
          Import-Module PSWSMan -Force -ErrorAction Stop
          Get-Module PSWSMan

          Write-Host "ğŸ”§ Installing WSMan client (needs root)..." -ForegroundColor Cyan
          sudo $(which pwsh) -Command 'Install-Module -Name PSWSMan -Force -AllowClobber; Import-Module PSWSMan; Install-WSMan'

          Write-Host "âœ… PowerShell modules installed" -ForegroundColor Green

      - name: Test connectivity
        shell: pwsh
        run: |
          Write-Host "ğŸ” Testing connectivity to ${{ inputs.target_dc }}..." -ForegroundColor Cyan
          
          try {
            Test-Connection -TargetName "${{ inputs.target_dc }}" -TCPPort 5985 -Count 1 -ErrorAction Stop
            Write-Host "âœ… WinRM port 5985 is reachable" -ForegroundColor Green
          } catch {
            Write-Host "âŒ Cannot reach WinRM port 5985" -ForegroundColor Red
            exit 1
          }

      - name: Promote to Domain Controller
        shell: pwsh
        env:
          DOMAIN_ADMIN_USER: ${{ secrets.DOMAIN_ADMIN_USERNAME }}
          DOMAIN_ADMIN_PASS: ${{ secrets.DOMAIN_ADMIN_PASSWORD }}
          SAFE_MODE_PASS: ${{ secrets.SAFE_MODE_PASSWORD }}
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host "  DC Promotion - linkedin.local" -ForegroundColor Cyan
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Target: ${{ inputs.target_dc }}" -ForegroundColor Yellow
          Write-Host ""

          $securePassword = ConvertTo-SecureString $env:DOMAIN_ADMIN_PASS -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential($env:DOMAIN_ADMIN_USER, $securePassword)
          $safeModePassword = ConvertTo-SecureString $env:SAFE_MODE_PASS -AsPlainText -Force

          try {
            Write-Host "ğŸ“¡ Creating remote PowerShell session..." -ForegroundColor Cyan
            $session = New-PSSession -ComputerName "${{ inputs.target_dc }}" -Credential $credential -SessionOption (New-PSSessionOption -SkipCACheck -SkipCNCheck)
            Write-Host "âœ… Session established" -ForegroundColor Green
            Write-Host ""

            Write-Host "ğŸ“¦ Installing AD DS Role..." -ForegroundColor Cyan
            Invoke-Command -Session $session -ScriptBlock {
              $result = Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools
              return $result.Success
            }
            Write-Host "âœ… AD DS Role installed" -ForegroundColor Green
            Write-Host ""

            Write-Host "ğŸš€ Promoting to Domain Controller..." -ForegroundColor Cyan
            Write-Host "â³ This will take 10-15 minutes..." -ForegroundColor Yellow
            Write-Host ""
            
            Invoke-Command -Session $session -ArgumentList $safeModePassword -ScriptBlock {
              param($SafeModePwd)
              Install-ADDSForest `
                -DomainName "linkedin.local" `
                -DomainNetbiosName "LINKEDIN" `
                -ForestMode "WinThreshold" `
                -DomainMode "WinThreshold" `
                -InstallDns:$true `
                -SafeModeAdministratorPassword $SafeModePwd `
                -Force:$true `
                -NoRebootOnCompletion:$false
            }

            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host "  âœ… DC PROMOTION INITIATED!" -ForegroundColor Green
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Green
            Write-Host ""
            Write-Host "Server is rebooting and completing promotion..." -ForegroundColor Yellow
            Write-Host "Domain: linkedin.local" -ForegroundColor White
            Write-Host "DC: ${{ inputs.target_dc }}" -ForegroundColor White
            Write-Host ""

          } catch {
            Write-Host ""
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host "  âŒ DC PROMOTION FAILED" -ForegroundColor Red
            Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Red
            Write-Host ""
            Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            exit 1
          } finally {
            if ($session) {
              Remove-PSSession -Session $session -ErrorAction SilentlyContinue
            }
          }
