name: Deploy to Lab (Simplified)

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: "Target VM name"
        required: true
        type: string
        default: "TestVM1300"
      target_dc:
        description: "Target DC IP (for reference)"
        required: false
        type: string
        default: "20.50.126.169"
      admin_username:
        description: "Local admin username on target VM"
        required: false
        type: string
        default: "azureuser"
      skip_validation:
        description: "Skip pre-promotion checks"
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      vm_name:
        description: "Target VM name"
        required: true
        type: string
      target_dc:
        description: "Target DC IP (for reference)"
        required: false
        type: string
      admin_username:
        description: "Local admin username on target VM"
        required: false
        type: string
        default: "azureuser"
      skip_validation:
        description: "Skip pre-promotion checks"
        required: false
        type: boolean
        default: false
    secrets:
      DOMAIN_ADMIN_USERNAME:
        required: true
      DOMAIN_ADMIN_PASSWORD:
        required: true
      SAFE_MODE_PASSWORD:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install AD DS Role
        shell: bash
        env:
          VM_NAME: ${{ inputs.vm_name }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Installing AD DS Role on $VM_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          echo "ðŸ“¦ Installing AD-Domain-Services..."
          RESULT=$(az vm run-command invoke \
            --resource-group VAMDEVTEST \
            --name "$VM_NAME" \
            --command-id RunPowerShellScript \
            --scripts "Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools | ConvertTo-Json" \
            -o json)
          
          echo "$RESULT" | jq -r '.value[0].message'
          
          EXIT_CODE=$(echo "$RESULT" | jq -r '.value[0].code')
          if [ "$EXIT_CODE" = "ComponentStatus/StdOut/succeeded" ]; then
            echo "âœ… AD DS Role installed successfully"
          else
            echo "âŒ AD DS Role installation failed (code: $EXIT_CODE)"
            exit 1
          fi

      - name: Prepare VM for Domain Join
        shell: bash
        env:
          VM_NAME: ${{ inputs.vm_name }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Preparing $VM_NAME for Domain Join"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          cat > /tmp/prepare-vm.ps1 << 'EOFPS1'
          # Configure DNS to point to DC01
          Write-Host "[1/2] Configuring DNS..." -ForegroundColor Cyan
          Set-DnsClientServerAddress -InterfaceAlias 'Ethernet*' -ServerAddresses 10.0.0.6,8.8.8.8
          Write-Host "DNS Servers:" -ForegroundColor Yellow
          Get-DnsClientServerAddress -InterfaceAlias 'Ethernet*' | Format-Table
          
          # Configure TrustedHosts for CIM/WinRM
          Write-Host "[2/2] Configuring TrustedHosts..." -ForegroundColor Cyan
          Set-Item WSMan:\localhost\Client\TrustedHosts -Value '10.0.0.6,DC01,DC01.linkedin.local,*.linkedin.local' -Force
          
          Write-Host "âœ… VM prepared for domain join" -ForegroundColor Green
          EOFPS1
          
          az vm run-command invoke \
            --resource-group VAMDEVTEST \
            --name "$VM_NAME" \
            --command-id RunPowerShellScript \
            --scripts @/tmp/prepare-vm.ps1 \
            -o json | jq -r '.value[0].message'
          
          echo ""
          echo "âœ… DNS and TrustedHosts configured"
          echo ""

      - name: Promote to Domain Controller
        shell: bash
        env:
          VM_NAME: ${{ inputs.vm_name }}
          DOMAIN_ADMIN_USER: ${{ secrets.DOMAIN_ADMIN_USERNAME }}
          DOMAIN_ADMIN_PASS: ${{ secrets.DOMAIN_ADMIN_PASSWORD }}
          SAFE_MODE_PASS: ${{ secrets.SAFE_MODE_PASSWORD }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Promoting $VM_NAME to Domain Controller"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸš€ Adding to domain: linkedin.local"
          echo "â³ This will take 10-15 minutes..."
          echo ""
          
          # Create PowerShell script for DC promotion
          cat > /tmp/promote-dc.ps1 << 'EOFPS1'
          param($DomainPass, $SafePass)
          
          try {
            # Use full domain format: linkedin.local\vamdev
            $domainSecure = ConvertTo-SecureString $DomainPass -AsPlainText -Force
            $domainCred = New-Object System.Management.Automation.PSCredential("linkedin.local\vamdev", $domainSecure)
            
            $safeModeSecure = ConvertTo-SecureString $SafePass -AsPlainText -Force
            
            Write-Host "Starting DC promotion with user: linkedin.local\vamdev" -ForegroundColor Cyan
            Write-Host "Replication source: DC01.linkedin.local" -ForegroundColor Yellow
            Write-Host ""
            
            Install-ADDSDomainController `
              -DomainName "linkedin.local" `
              -Credential $domainCred `
              -ReplicationSourceDC "DC01.linkedin.local" `
              -SiteName "Default-First-Site-Name" `
              -InstallDns:$true `
              -CreateDnsDelegation:$false `
              -SafeModeAdministratorPassword $safeModeSecure `
              -NoRebootOnCompletion:$false `
              -Confirm:$false `
              -ErrorAction Stop
              
            Write-Host "âœ… DC PROMOTION COMPLETED" -ForegroundColor Green
            
          } catch {
            Write-Host "âŒ DC PROMOTION ERROR: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host ""
            Write-Host "Full Error:" -ForegroundColor Red
            Write-Host "$_" -ForegroundColor Red
            throw
          }
          EOFPS1
          
          # Execute via Azure VM Run Command
          echo "Executing DC promotion script..."
          RESULT=$(az vm run-command invoke \
            --resource-group VAMDEVTEST \
            --name "$VM_NAME" \
            --command-id RunPowerShellScript \
            --scripts @/tmp/promote-dc.ps1 \
            --parameters "DomainPass=$DOMAIN_ADMIN_PASS" "SafePass=$SAFE_MODE_PASS" \
            -o json)
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "DC Promotion Output:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          OUTPUT_MSG=$(echo "$RESULT" | jq -r '.value[0].message')
          echo "$OUTPUT_MSG"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Check for success (must appear BEFORE checking for errors)
          if echo "$OUTPUT_MSG" | grep -q "âœ… DC PROMOTION COMPLETED"; then
            echo "âœ…âœ…âœ… DC PROMOTION SUCCESSFUL! âœ…âœ…âœ…"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "  âœ… TestVM1300 ADDED TO linkedin.local"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Domain: linkedin.local"
            echo "New DC: $VM_NAME"
            echo ""
          elif echo "$OUTPUT_MSG" | grep -qi "âŒ DC PROMOTION ERROR\|The operation failed\|Cannot complete"; then
            echo "âŒâŒâŒ DC PROMOTION FAILED! âŒâŒâŒ"
            echo ""
            echo "Error found in output above"
            exit 1
          else
            echo "âš ï¸  Unexpected output - check logs above"
            exit 1
          fi
