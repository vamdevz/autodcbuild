name: Deploy to Lab (Simplified)

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: "Target VM name"
        required: true
        type: string
        default: "TestVM1300"
      target_dc:
        description: "Target DC IP (for reference)"
        required: false
        type: string
        default: "20.50.126.169"
      admin_username:
        description: "Local admin username on target VM"
        required: false
        type: string
        default: "azureuser"
      skip_validation:
        description: "Skip pre-promotion checks"
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      vm_name:
        description: "Target VM name"
        required: true
        type: string
      target_dc:
        description: "Target DC IP (for reference)"
        required: false
        type: string
      admin_username:
        description: "Local admin username on target VM"
        required: false
        type: string
        default: "azureuser"
      skip_validation:
        description: "Skip pre-promotion checks"
        required: false
        type: boolean
        default: false
    secrets:
      DOMAIN_ADMIN_USERNAME:
        required: true
      DOMAIN_ADMIN_PASSWORD:
        required: true
      SAFE_MODE_PASSWORD:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install AD DS Role
        shell: bash
        env:
          VM_NAME: ${{ inputs.vm_name }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Installing AD DS Role on $VM_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          echo "ðŸ“¦ Installing AD-Domain-Services..."
          RESULT=$(az vm run-command invoke \
            --resource-group VAMDEVTEST \
            --name "$VM_NAME" \
            --command-id RunPowerShellScript \
            --scripts "Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools | ConvertTo-Json" \
            -o json)
          
          echo "$RESULT" | jq -r '.value[0].message'
          
          EXIT_CODE=$(echo "$RESULT" | jq -r '.value[0].code')
          if [ "$EXIT_CODE" = "ComponentStatus/StdOut/succeeded" ]; then
            echo "âœ… AD DS Role installed successfully"
          else
            echo "âŒ AD DS Role installation failed (code: $EXIT_CODE)"
            exit 1
          fi

      - name: Configure DNS
        shell: bash
        env:
          VM_NAME: ${{ inputs.vm_name }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Configuring DNS on $VM_NAME"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Setting DNS to point to DC01 (10.0.0.6)..."
          
          az vm run-command invoke \
            --resource-group VAMDEVTEST \
            --name "$VM_NAME" \
            --command-id RunPowerShellScript \
            --scripts "Set-DnsClientServerAddress -InterfaceAlias 'Ethernet*' -ServerAddresses 10.0.0.6,8.8.8.8; Get-DnsClientServerAddress -InterfaceAlias 'Ethernet*' | Format-Table" \
            -o json | jq -r '.value[0].message'
          
          echo "âœ… DNS configured to use DC01 as primary DNS"
          echo ""

      - name: Promote to Domain Controller
        shell: bash
        env:
          VM_NAME: ${{ inputs.vm_name }}
          DOMAIN_ADMIN_USER: ${{ secrets.DOMAIN_ADMIN_USERNAME }}
          DOMAIN_ADMIN_PASS: ${{ secrets.DOMAIN_ADMIN_PASSWORD }}
          SAFE_MODE_PASS: ${{ secrets.SAFE_MODE_PASSWORD }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  Promoting $VM_NAME to Domain Controller"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸš€ Adding to domain: linkedin.local"
          echo "â³ This will take 10-15 minutes..."
          echo ""
          
          # Create PowerShell script for DC promotion
          cat > /tmp/promote-dc.ps1 << 'EOFPS1'
          param($DomainUser, $DomainPass, $SafePass)
          
          try {
            $domainSecure = ConvertTo-SecureString $DomainPass -AsPlainText -Force
            $domainCred = New-Object System.Management.Automation.PSCredential($DomainUser, $domainSecure)
            
            $safeModeSecure = ConvertTo-SecureString $SafePass -AsPlainText -Force
            
            Write-Host "Starting DC promotion..." -ForegroundColor Cyan
            
            Install-ADDSDomainController `
              -DomainName "linkedin.local" `
              -Credential $domainCred `
              -InstallDns:$true `
              -SafeModeAdministratorPassword $safeModeSecure `
              -Force:$true `
              -NoRebootOnCompletion:$false `
              -Confirm:$false
              
            Write-Host "DC promotion initiated" -ForegroundColor Green
            
          } catch {
            Write-Host "ERROR: $($_.Exception.Message)" -ForegroundColor Red
            throw
          }
          EOFPS1
          
          # Execute via Azure VM Run Command
          echo "Executing DC promotion script..."
          RESULT=$(az vm run-command invoke \
            --resource-group VAMDEVTEST \
            --name "$VM_NAME" \
            --command-id RunPowerShellScript \
            --scripts @/tmp/promote-dc.ps1 \
            --parameters "DomainUser=$DOMAIN_ADMIN_USER" "DomainPass=$DOMAIN_ADMIN_PASS" "SafePass=$SAFE_MODE_PASS" \
            -o json)
          
          echo ""
          echo "Output:"
          echo "$RESULT" | jq -r '.value[0].message'
          echo ""
          
          if echo "$RESULT" | grep -q "DC promotion initiated"; then
            echo "âœ… DC promotion command executed successfully!"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "  âœ… DC PROMOTION INITIATED!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Server is now rebooting and completing promotion..."
            echo "Domain: linkedin.local"
            echo "New DC: $VM_NAME"
          else
            echo "âŒ DC promotion failed - check output above"
            exit 1
          fi
