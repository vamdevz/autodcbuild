name: Full DC Automation

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: "Name for the new Windows Server VM"
        required: true
        type: string
      admin_username:
        description: "Local admin username for the VM"
        required: false
        type: string
        default: "azureuser"
      skip_validation:
        description: "Skip pre-promotion checks"
        required: false
        type: boolean
        default: false

jobs:
  create-vm:
    runs-on: ubuntu-latest
    outputs:
      vm_name: ${{ steps.outputs.outputs.vm_name }}
      vm_ip: ${{ steps.outputs.outputs.vm_ip }}
    steps:
      - name: Trigger VM creation workflow
        id: trigger
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run create-vm.yml \
            --repo "${{ github.repository }}" \
            -f vm_name="${{ inputs.vm_name }}" \
            -f admin_username="${{ inputs.admin_username }}"

      - name: Wait for VM creation workflow
        id: wait
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Waiting for create-vm.yml to finish..."
          RUN_ID="$(gh run list --workflow=create-vm.yml --limit 1 --json databaseId --jq '.[0].databaseId')"
          echo "Latest create-vm run: $RUN_ID"
          gh run watch "$RUN_ID" --exit-status

      - name: Download VM details
        id: download
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          RUN_ID="$(gh run list --workflow=create-vm.yml --limit 1 --json databaseId --jq '.[0].databaseId')"
          gh run view "$RUN_ID" --json jobs --jq '.jobs[0].steps[] | select(.name=="Outputs").number' > /tmp/step.txt || true
          gh run download "$RUN_ID" --name vm-details || true

      - name: Set outputs
        id: outputs
        run: |
          if [ -f vm-details.txt ]; then
            cat vm-details.txt
            VM_NAME="$(grep '^vm_name=' vm-details.txt | cut -d= -f2)"
            VM_IP="$(grep '^vm_ip=' vm-details.txt | cut -d= -f2)"
          else
            echo "vm-details.txt not found, using latest VM outputs from workflow run"
            VM_NAME="${{ inputs.vm_name }}"
            VM_IP=""
          fi
          echo "vm_name=$VM_NAME" >> "$GITHUB_OUTPUT"
          echo "vm_ip=$VM_IP" >> "$GITHUB_OUTPUT"

  promote-dc:
    needs: create-vm
    runs-on: ubuntu-latest
    steps:
      - name: Display VM details
        run: |
          echo "==================================="
          echo "  VM Created Successfully"
          echo "==================================="
          echo "VM Name: ${{ needs.create-vm.outputs.vm_name }}"
          echo "VM IP: ${{ needs.create-vm.outputs.vm_ip }}"
          echo ""
          echo "Now triggering DC promotion..."
          
      - name: Trigger DC promotion
        id: trigger
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -z "${{ needs.create-vm.outputs.vm_name }}" ]; then
            echo "ERROR: VM name is missing. Cannot trigger DC promotion."
            exit 1
          fi
          
          echo "Triggering DC promotion for ${{ needs.create-vm.outputs.vm_name }}..."
          gh workflow run deploy-lab.yml \
            --repo "${{ github.repository }}" \
            -f vm_name="${{ needs.create-vm.outputs.vm_name }}" \
            -f target_dc="${{ needs.create-vm.outputs.vm_ip }}" \
            -f admin_username="${{ inputs.admin_username }}" \
            -f skip_validation="${{ inputs.skip_validation }}"
          
          echo "DC promotion workflow triggered successfully!"
          
      - name: Wait for DC promotion to start
        run: |
          echo "Waiting 10 seconds for workflow to start..."
          sleep 10
          
      - name: Monitor DC promotion
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Monitoring DC promotion workflow..."
          echo ""
          
          RUN_ID="$(gh run list --workflow=deploy-lab.yml --limit 1 --json databaseId --jq '.[0].databaseId')"
          echo "DC Promotion Run ID: $RUN_ID"
          echo "URL: https://github.com/${{ github.repository }}/actions/runs/$RUN_ID"
          echo ""
          
          echo "Watching workflow (this may take 10-15 minutes for DC promotion)..."
          gh run watch "$RUN_ID" --exit-status
          
          echo ""
          echo "==================================="
          echo "  DC Promotion Completed!"
          echo "==================================="
          echo "VM: ${{ needs.create-vm.outputs.vm_name }}"
          echo "Domain: linkedin.local"
          echo ""
