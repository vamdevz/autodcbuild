---
# roles/dc-promotion/tasks/main.yml
# Core DC promotion tasks

- name: Include domain-specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ domain_name }}.yml"
    - "default.yml"

- name: Check DNS configuration
  win_shell: |
    $dnsServers = (Get-DnsClientServerAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -notlike "*Loopback*"}).ServerAddresses
    if ($dnsServers -notcontains "{{ primary_dc_ip }}") {
      throw "DNS not pointing to existing DC"
    }
  register: dns_check
  changed_when: false

- name: Test connectivity to existing DC
  win_ping:
    data: "{{ primary_dc_ip }}"
  register: dc_ping
  failed_when: dc_ping.ping != "pong"

- name: Install AD DS Role
  win_feature:
    name: AD-Domain-Services
    include_management_tools: yes
    include_sub_features: yes
    state: present
  register: adds_install

- name: Reboot if AD DS role installation requires it
  win_reboot:
    reboot_timeout: 600
  when: adds_install.reboot_required

- name: Wait for system to become reachable
  wait_for_connection:
    timeout: 300
    delay: 60
  when: adds_install.reboot_required

- name: Promote server to Domain Controller
  win_domain_controller:
    dns_domain_name: "{{ domain_name }}"
    domain_admin_user: "{{ domain_admin_user }}@{{ domain_name }}"
    domain_admin_password: "{{ domain_admin_password }}"
    safe_mode_password: "{{ dsrm_password }}"
    state: domain_controller
    site_name: "{{ ad_site_name | default(omit) }}"
    database_path: "{{ adds_database_path | default('C:\\Windows\\NTDS') }}"
    sysvol_path: "{{ adds_sysvol_path | default('C:\\Windows\\SYSVOL') }}"
    log_path: "{{ adds_log_path | default('C:\\Windows\\NTDS') }}"
    read_only: "{{ read_only_dc | default(false) }}"
  register: dc_promotion
  async: 3600
  poll: 30
  notify:
    - reboot after promotion
    - wait for dc services

- name: Display promotion result
  debug:
    msg: "DC Promotion status: {{ dc_promotion }}"
